@page "/reservations"

@attribute [Authorize]

@using System.Security.Claims
@inject AuthenticationStateProvider _authStateProvider
@inject IReservationService _reservationService
@inject NavigationManager _navigationManager

<RadzenStack Gap="12px">
    <RadzenDataGrid TItem="Reservation"
                    Data="@Items"
                    AllowPaging="true"
                    PageSize="10"
                    AllowSorting="true"
                    AllowFiltering="true"
                    FilterMode="FilterMode.Simple"
                    Responsive="true"
                    ColumnWidth="180px"
                    EmptyText="No reservations found.">
        <Columns>
            <RadzenDataGridColumn TItem="Reservation"
                                  Property="Room.RoomNumber"
                                  Title="Room No"
                                  Width="60px">
                <Template Context="r">
                    @r.Room?.RoomNumber
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Reservation" Property="CheckIn" Title="Check-In" Width="120px"/>
            <RadzenDataGridColumn TItem="Reservation" Property="CheckOut" Title="Check-Out" Width="120px"/>

            <RadzenDataGridColumn TItem="Reservation" 
                                  Property="Status"
                                  Title="Status" 
                                  Width="120px">
                <Template Context="r">
                    <RadzenBadge Text="@r.Status.ToString()"
                                 BadgeStyle="@BadgeStyles.ForReservationStatus(r.Status)" />
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Reservation" Title="Actions" Width="320px" Sortable="false" Filterable="false">
                <Template Context="r">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">

                        <AuthorizeView Roles="@AppRoles.Employee">
                            @if (r.Status == ReservationStatus.Pending)
                            {
                                <RadzenButton Text="Confirm"
                                              ButtonStyle="ButtonStyle.Success"
                                              Size="ButtonSize.Small"
                                              Click="@(() => Confirm(r.Id))" />

                                <RadzenButton Text="Cancel"
                                              ButtonStyle="ButtonStyle.Danger"
                                              Size="ButtonSize.Small"
                                              Click="@(() => Cancel(r.Id))" />
                            }
                            else if (r.Status == ReservationStatus.Confirmed)
                            {
                                <RadzenButton Text="Check-in"
                                              ButtonStyle="ButtonStyle.Success"
                                              Size="ButtonSize.Small"
                                              Click="@(() => CheckIn(r.Id))" />

                                <RadzenButton Text="NoShow"
                                              ButtonStyle="ButtonStyle.Secondary"
                                              Size="ButtonSize.Small"
                                              Click="@(() => NoShow(r.Id))" />

                                <RadzenButton Text="Cancel"
                                              ButtonStyle="ButtonStyle.Danger"
                                              Size="ButtonSize.Small"
                                              Click="@(() => Cancel(r.Id))" />
                            }
                            else if (r.Status == ReservationStatus.CheckedIn)
                            {
                                <RadzenButton Text="Check-out"
                                              ButtonStyle="ButtonStyle.Warning"
                                              Size="ButtonSize.Small"
                                              Click="@(() => CheckOut(r.Id))" />
                            }
                            else
                            {
                                <RadzenText TextStyle="TextStyle.Caption">Read-only</RadzenText>
                            }
                        </AuthorizeView>

                        <AuthorizeView Roles="@AppRoles.Customer">
                            @if (r.Status == ReservationStatus.Pending || r.Status == ReservationStatus.Confirmed)
                            {
                                <RadzenButton Text="Cancel"
                                              ButtonStyle="ButtonStyle.Danger"
                                              Size="ButtonSize.Small"
                                              Click="@(() => Cancel(r.Id))" />
                            }
                            else
                            {
                                <RadzenText TextStyle="TextStyle.Caption">Read-only</RadzenText>
                            }
                        </AuthorizeView>

                        <RadzenButton Text="Details"
                                      ButtonStyle="ButtonStyle.Light"
                                      Size="ButtonSize.Small"
                                      Click="@(() => _navigationManager.NavigateTo($"/reservations/{r.Id}"))" />
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</RadzenStack>

@code {
    private IEnumerable<Reservation> Items { get; set; } = new List<Reservation>();
    private bool _isEmployee;
    private string? _userId;
    protected override async Task OnInitializedAsync()
    {
        var state = await _authStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        _isEmployee = user.IsInRole(AppRoles.Employee);
        _userId = user.FindFirstValue(ClaimTypes.NameIdentifier);

        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        Items = await _reservationService.GetVisibleAsync(_isEmployee, _userId);
    }

    private async Task Confirm(int id)
    {
        await _reservationService.ConfirmAsync(id);
        await LoadAsync();
    }

    private async Task Cancel(int id)
    {
        await _reservationService.CancelAsync(id);
        await LoadAsync();
    }

    private async Task NoShow(int id)
    {
        await _reservationService.MarkNoShowAsync(id);
        await LoadAsync();
    }
    private async Task CheckIn(int id)
    {
        await _reservationService.CheckInAsync(id);
        await LoadAsync();
    }

    private async Task CheckOut(int id)
    {
        await _reservationService.CheckOutAsync(id);
        await LoadAsync();
    }

}