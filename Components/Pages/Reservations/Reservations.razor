@page "/reservations"

@attribute [Authorize]

@inject IReservationService _reservationService
@inject NavigationManager _navigationManager

<RadzenStack Gap="12px">
    <RadzenDataGrid TItem="Reservation"
                    Data="@Items"
                    AllowPaging="true"
                    PageSize="10"
                    AllowSorting="true"
                    AllowFiltering="true"
                    FilterMode="FilterMode.Simple"
                    Responsive="true"
                    ColumnWidth="180px"
                    EmptyText="No reservations found.">
        <Columns>
            <RadzenDataGridColumn TItem="Reservation"
                                  Property="Room.RoomNumber"
                                  Title="Room No"
                                  Width="60px">
                <Template Context="r">
                    @r.Room?.RoomNumber
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Reservation" Property="CheckIn" Title="Check-In" Width="120px"/>
            <RadzenDataGridColumn TItem="Reservation" Property="CheckOut" Title="Check-Out" Width="120px"/>

            <RadzenDataGridColumn TItem="Reservation" 
                                  Property="Status"
                                  Title="Status" 
                                  Width="120px">
                <Template Context="r">
                    <RadzenBadge Text="@r.Status.ToString()"
                                 BadgeStyle="@BadgeStyles.ForReservationStatus(r.Status)" />
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Reservation" Title="Actions" Width="260px" Sortable="false" Filterable="false">
                <Template Context="r">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                        @if (r.Status == ReservationStatus.Confirmed)
                        {
                            <RadzenButton Text="Check-in"
                                          ButtonStyle="ButtonStyle.Success"
                                          Size="ButtonSize.Small"
                                          Click="@(() => CheckIn(r.Id))" />

                            <RadzenButton Text="NoShow"
                                          ButtonStyle="ButtonStyle.Secondary"
                                          Size="ButtonSize.Small"
                                          Disabled="true" />

                            <RadzenButton Text="Cancel"
                                          ButtonStyle="ButtonStyle.Danger"
                                          Size="ButtonSize.Small"
                                          Disabled="true" />
                        }
                        else if (r.Status == ReservationStatus.CheckedIn)
                        {
                            <RadzenButton Text="Check-out"
                                          ButtonStyle="ButtonStyle.Warning"
                                          Size="ButtonSize.Small"
                                          Click="@(() => CheckOut(r.Id))" />
                        }
                        <RadzenButton Text="Details"
                                      ButtonStyle="ButtonStyle.Light"
                                      Size="ButtonSize.Small"
                                      Click="@(() => _navigationManager.NavigateTo($"/reservations/{r.Id}"))" />
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</RadzenStack>

@code {
    private IEnumerable<Reservation> Items { get; set; } = new List<Reservation>();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        Items = await _reservationService.GetAllAsync();
    }

    private async Task CheckIn(int id)
    {
        await _reservationService.CheckInAsync(id);
        await LoadAsync();
    }

    private async Task CheckOut(int id)
    {
        await _reservationService.CheckOutAsync(id);
        await LoadAsync();
    }

}