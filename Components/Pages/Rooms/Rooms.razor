@page "/rooms"

@inject AuthenticationStateProvider _authStateProvider
@inject NavigationManager _navigationManager
@inject IRoomService _roomService


<RadzenDataGrid TItem="Room"
                 Data="@Items"
                 AllowPaging="true"
                 PageSize="10"      
                 AllowSorting="true"
                 AllowFiltering="true"
                 FilterMode="FilterMode.Simple"
                 Responsive="true"
                 ColumnWidth="180px"
                 EmptyText="No room found.">
    <Columns>

        <RadzenDataGridColumn TItem="Room"
                              Property="RoomNumber"
                              Title="Room No" />

        <RadzenDataGridColumn TItem="Room"
                              Property="RoomType"
                              Title="Room Type">
            <Template Context="r">
                <RadzenBadge Text="@r.RoomType.ToString()" />
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn TItem="Room"
                              Property="Capacity"
                              Title="Capacity" />

        <RadzenDataGridColumn TItem="Room"
                              Property="BasePrice"
                              Title="Price/Night">
            <Template Context="r">
                @($"{r.BasePrice:n0} â‚º")
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn TItem="Room"
                              Property="Status"
                              Title="Status">
            <Template Context="r">
                <RadzenBadge Text="@r.Status.ToString()" />
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn TItem="Room" Title="" Width="260px" Sortable="false" Filterable="false">
            <Template Context="r">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="8px">
                    @if (_isAuthenticated == false)
                    {
                        <RadzenButton Variant="Variant.Flat" 
                                      Text="Reserve"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Click="@(() => RedirectToLoginForReservation(r.Id))" />
                    }
                    else if (_isCustomer)
                    {
                        <RadzenButton Variant="Variant.Flat" 
                                      Text="Reserve"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Click="@(() => GoReservationCreate(r.Id))" />
                    }
                </RadzenStack>
            </Template>
        </RadzenDataGridColumn>

    </Columns>
</RadzenDataGrid>

@code {

    private IEnumerable<Room> Items { get; set; } = new List<Room>();
    private bool _isAuthenticated;
    private bool _isCustomer;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserFlagsAsync();
        await LoadRoomsAsync();
    }

    private async Task LoadUserFlagsAsync()
    {
        var state = await _authStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        _isAuthenticated = user.Identity?.IsAuthenticated == true;
        _isCustomer = user.IsInRole(AppRoles.Customer);
    }

    private async Task LoadRoomsAsync()
    {
        var allRooms = await _roomService.GetAllAsync();

        if (!_isAuthenticated || _isCustomer)
        {
            Items = allRooms.Where(r => r.Status == RoomStatus.Available).ToList();
        }
        else
        {
            Items = allRooms;
        }
    }

    private async Task OnRoomTypeFilterChanged()
    {
        await LoadRoomsAsync();
    }

    private void GoReservationCreate(int roomId)
    {
        _navigationManager.NavigateTo($"/reservations/create?roomId={roomId}");
    }

    private void RedirectToLoginForReservation(int roomId)
    {
        var returnUrl = $"/reservations/create?roomId={roomId}";
        var url = QueryHelpers.AddQueryString("/Account/Login", "returnUrl", returnUrl);
        _navigationManager.NavigateTo(url, forceLoad: true);
    }
}